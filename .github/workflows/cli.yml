name: CLI Release

on:
  push:
    branches: [main]
    paths:
      - 'package.json'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for CLI version bump
        id: version
        run: |
          NEW=$(jq -r '.cliVersion' package.json)
          if [ -z "$NEW" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          elif gh release view "cli-v$NEW" &>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "version=$NEW" >> "$GITHUB_OUTPUT"
            echo "tag=cli-v$NEW" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        if: steps.version.outputs.changed == 'true'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.version.outputs.changed == 'true'
        run: bun install

      - name: Sync SvelteKit types
        if: steps.version.outputs.changed == 'true'
        run: bunx svelte-kit sync

      - name: Build binaries
        if: steps.version.outputs.changed == 'true'
        run: |
          mkdir -p dist/cli
          bun build src/cli/main.ts --compile --target=bun-linux-x64 --outfile dist/cli/difflog-linux-x64
          bun build src/cli/main.ts --compile --target=bun-darwin-arm64 --outfile dist/cli/difflog-darwin-arm64
          bun build src/cli/main.ts --compile --target=bun-darwin-x64 --outfile dist/cli/difflog-darwin-x64

      - name: Create release
        if: steps.version.outputs.changed == 'true'
        run: |
          PREV_TAG=$(gh release list --json tagName -q '[.[].tagName | select(startswith("cli-v"))] | .[0] // empty')
          NOTES_FLAG=""
          if [ -n "$PREV_TAG" ]; then
            NOTES_FLAG="--notes-start-tag $PREV_TAG"
          fi
          gh release create "${{ steps.version.outputs.tag }}" \
            dist/cli/difflog-linux-x64 \
            dist/cli/difflog-darwin-arm64 \
            dist/cli/difflog-darwin-x64 \
            --title "CLI ${{ steps.version.outputs.version }}" \
            --generate-notes \
            $NOTES_FLAG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
