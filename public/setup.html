<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>diff·log - Setup</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
  <script type="module" src="/app.js"></script>
</head>
<body>
  <main id="content" class="narrow" x-data="setup()">
      <header>
        <div class="logo-mark">&#9670;</div>
        <h1 class="setup-title">diff<span class="setup-diamond">&#9670;</span>log</h1>
        <p class="setup-subtitle" x-text="isEditing ? 'Edit Profile' : 'Configure Your Diff'"></p>
        <div class="step-indicator">
          <template x-for="i in 7" :key="i">
            <div class="step-dot"
              :class="{
                'step-dot-active': (i - 1) === step,
                'step-dot-complete': (i - 1) < step
              }"></div>
          </template>
        </div>
      </header>

      <div class="setup-content">
        <!-- Step 0: Name -->
        <div x-show="step === 0" x-transition.opacity>
          <h2 class="step-title" x-text="data.name.trim() ? (hasExistingProfiles ? data.name.trim() : 'Welcome, ' + data.name.trim()) : (hasExistingProfiles ? 'New Profile' : 'Welcome')"></h2>
          <p class="step-desc">Configure your personalized diff. We'll scan the developer ecosystem and surface only what's changed since you last checked in.</p>
          <p class="step-desc" style="margin-top: 0.5rem;">
            <a href="/profiles" class="link-subtle" @click="sessionStorage.setItem('openImport', '1')">Have an uploaded profile? Sign in here.</a>
          </p>
          <div class="input-group">
            <label class="input-label" x-text="hasExistingProfiles ? 'Name this profile' : 'What should we call you?'"></label>
            <input type="text" class="text-input" :placeholder="hasExistingProfiles ? 'Profile name' : 'Enter your name or handle'"
              x-model="data.name" autofocus @keydown.enter.prevent="if (data.name.trim()) step++" />
          </div>
        </div>

        <!-- Step 1: API Providers -->
        <div x-show="step === 1" x-transition.opacity>
          <h2 class="step-title">Connect API Providers</h2>
          <p class="step-desc">Add your API key to generate diffs. You can optionally use multiple providers for different steps.</p>

          <!-- Import existing keys prompt -->
          <div class="key-import-prompt" x-show="hasExistingKeys" x-cloak>
            <div class="key-import-content">
              <span class="key-import-check">&#10003;</span>
              <div class="key-import-text">
                <template x-if="missingKeys.length === 1">
                  <span class="key-import-title">You have the <span x-text="existingKeyNames"></span> key in another profile</span>
                </template>
                <template x-if="missingKeys.length > 1">
                  <div>
                    <span class="key-import-title">You have API keys in other profiles</span>
                    <span class="key-import-providers" x-text="existingKeyNames"></span>
                  </div>
                </template>
              </div>
            </div>
            <button class="btn-secondary btn-import" @click="importExistingKeys()" x-text="missingKeys.length === 1 ? 'Use this key' : 'Use these keys'"></button>
          </div>

          <!-- Provider table -->
          <table class="provider-table">
            <thead>
              <tr>
                <th class="provider-col">Provider</th>
                <th class="step-col">Search</th>
                <th class="step-col">Curation</th>
                <th class="step-col">Synthesis</th>
                <th class="key-col"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Anthropic (always visible) -->
              <tr :class="{ 'provider-row-active': providers.anthropic.status === 'valid' }">
                <td class="provider-name">
                  <span>Anthropic</span>
                  <span x-show="providers.anthropic.status === 'valid'" class="provider-check">&#10003;</span>
                </td>
                <template x-for="s in steps" :key="s.id">
                  <td class="step-cell"
                      :class="{
                        'cell-selected': getCellState('anthropic', s.id) === 'selected',
                        'cell-available': getCellState('anthropic', s.id) === 'available',
                        'cell-unavailable': getCellState('anthropic', s.id) === 'unavailable',
                      }"
                      @click="toggleSelection('anthropic', s.id)">
                    <span x-show="getCellState('anthropic', s.id) === 'selected'" class="cell-icon">&#9679;</span>
                    <span x-show="getCellState('anthropic', s.id) === 'available'" class="cell-icon">&#9675;</span>
                    <span x-show="getCellState('anthropic', s.id) === 'unavailable'" class="cell-icon cell-icon-dim">&#9675;</span>
                  </td>
                </template>
                <td class="key-cell">
                  <button class="btn-key" :class="providers.anthropic.status === 'valid' ? 'btn-key-edit' : 'btn-key-add'"
                          @click="openKeyModal('anthropic')"
                          x-text="providers.anthropic.status === 'valid' ? 'Edit' : 'Add'">
                  </button>
                </td>
              </tr>

              <!-- Other providers toggle (hidden when any other provider is validated) -->
              <tr class="provider-row-toggle"
                  x-show="!providerList.some(p => p.id !== 'anthropic' && providers[p.id].status === 'valid')"
                  @click="showOtherProviders = !showOtherProviders">
                <td colspan="5" class="provider-toggle-cell">
                  <span class="provider-toggle-arrow" :class="{ 'provider-toggle-open': showOtherProviders }">&#9656;</span>
                  <span>Other providers</span>
                  <span class="provider-toggle-hint" x-show="!showOtherProviders">Serper, Perplexity, DeepSeek, Gemini</span>
                </td>
              </tr>

              <!-- Other providers (expandable, or always visible if any is validated) -->
              <template x-for="provider in providerList.filter(p => p.id !== 'anthropic')" :key="provider.id">
                <tr x-show="showOtherProviders || providerList.some(p => p.id !== 'anthropic' && providers[p.id].status === 'valid')"
                    :class="{ 'provider-row-active': providers[provider.id].status === 'valid' }">
                  <td class="provider-name">
                    <span x-text="provider.name"></span>
                    <span x-show="providers[provider.id].status === 'valid'" class="provider-check">&#10003;</span>
                  </td>

                  <template x-for="s in steps" :key="s.id">
                    <td class="step-cell"
                        :class="{
                          'cell-selected': getCellState(provider.id, s.id) === 'selected',
                          'cell-available': getCellState(provider.id, s.id) === 'available',
                          'cell-unavailable': getCellState(provider.id, s.id) === 'unavailable',
                          'cell-unsupported': getCellState(provider.id, s.id) === 'unsupported',
                        }"
                        @click="toggleSelection(provider.id, s.id)">
                      <span x-show="getCellState(provider.id, s.id) === 'selected'" class="cell-icon">&#9679;</span>
                      <span x-show="getCellState(provider.id, s.id) === 'available'" class="cell-icon">&#9675;</span>
                      <span x-show="getCellState(provider.id, s.id) === 'unavailable'" class="cell-icon cell-icon-dim">&#9675;</span>
                      <span x-show="getCellState(provider.id, s.id) === 'unsupported'" class="cell-icon cell-icon-none">&mdash;</span>
                    </td>
                  </template>

                  <td class="key-cell">
                    <button class="btn-key" :class="providers[provider.id].status === 'valid' ? 'btn-key-edit' : 'btn-key-add'"
                            @click="openKeyModal(provider.id)"
                            x-text="providers[provider.id].status === 'valid' ? 'Edit' : 'Add'">
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>

          <div class="cost-estimate" x-show="isProviderConfigComplete">
            <span class="cost-label">Est. cost per diff:</span>
            <span class="cost-value" x-text="formatCost(costEstimate.min) + ' – ' + formatCost(costEstimate.max)"></span>
          </div>

          <!-- Key edit modal -->
          <div x-show="editingProvider" class="key-modal-overlay" @click.self="cancelKeyModal()" x-cloak>
            <div class="key-modal" @click.stop>
              <template x-if="editingProvider">
                <div>
                  <h3 class="key-modal-title" x-text="getProviderConfig(editingProvider).name + ' API Key'"></h3>
                  <div class="key-input-group">
                    <input :type="providers[editingProvider].masked ? 'password' : 'text'"
                           class="key-input"
                           :placeholder="getProviderConfig(editingProvider).keyPlaceholder"
                           x-model="providers[editingProvider].key"
                           @keydown.enter="providers[editingProvider].status === 'valid' ? closeKeyModal() : validateProviderKey(editingProvider)" />
                    <button class="btn-mask" @click="toggleMask(editingProvider)" :title="providers[editingProvider].masked ? 'Show key' : 'Hide key'">
                      <!-- Eye open (visible) -->
                      <svg x-show="!providers[editingProvider].masked" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                      <!-- Eye closed (hidden) -->
                      <svg x-show="providers[editingProvider].masked" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>
                        <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/>
                        <path d="M1 1l22 22"/>
                      </svg>
                    </button>
                  </div>
                  <div class="key-status">
                    <span x-show="providers[editingProvider].status === 'validating'" class="status-validating">Validating...</span>
                    <span x-show="providers[editingProvider].status === 'valid'" class="status-valid">&#10003; Connected</span>
                    <span x-show="providers[editingProvider].status === 'invalid'" class="status-invalid">&#10007; Invalid key</span>
                  </div>
                  <div class="key-modal-actions">
                    <button class="btn-secondary" @click="cancelKeyModal()">Cancel</button>
                    <!-- Primary button: OK when valid, Remove when cleared, Verify otherwise -->
                    <button class="btn-primary"
                            @click="(originalEditingKey && !providers[editingProvider].key.trim()) ? (clearProviderKey(editingProvider), closeKeyModal()) :
                                   (providers[editingProvider].status === 'valid' && providers[editingProvider].key.trim()) ? closeKeyModal() :
                                   validateProviderKey(editingProvider)"
                            :disabled="providers[editingProvider].status === 'validating' ||
                                      (!providers[editingProvider].key.trim() && !originalEditingKey)">
                      <span x-show="providers[editingProvider].status === 'validating'">...</span>
                      <span x-show="providers[editingProvider].status === 'valid' && providers[editingProvider].key.trim()">OK</span>
                      <span x-show="originalEditingKey && !providers[editingProvider].key.trim() && providers[editingProvider].status !== 'validating'">Remove</span>
                      <span x-show="!(providers[editingProvider].status === 'validating') && !(providers[editingProvider].status === 'valid' && providers[editingProvider].key.trim()) && !(originalEditingKey && !providers[editingProvider].key.trim())">Verify</span>
                    </button>
                  </div>
                  <a :href="getProviderConfig(editingProvider).docsUrl" target="_blank" class="key-docs-link"
                     x-show="getProviderConfig(editingProvider).docsUrl">Get API key &rarr;</a>
                </div>
              </template>
            </div>
          </div>

          <div class="setup-error" x-show="setupError" x-text="setupError"></div>
        </div>

        <!-- Step 2: Languages -->
        <div x-show="step === 2" x-transition.opacity>
          <h2 class="step-title">Languages</h2>
          <p class="step-desc">Select the programming languages you work with or follow.</p>
          <div class="chip-grid">
            <template x-for="lang in languages" :key="lang">
              <button class="chip" :class="{ 'chip-selected': data.languages.includes(lang) }"
                @click="toggle('languages', lang)" x-text="lang"></button>
            </template>
            <template x-for="item in getCustomItems('languages')" :key="item">
              <span class="chip chip-selected chip-custom">
                <span x-text="item"></span>
                <button class="chip-remove" @click="removeCustom('languages', item)">&times;</button>
              </span>
            </template>
            <span class="chip-add-inline">
              <input type="text" class="chip-add-input" placeholder="+ Add custom"
                x-model="customInput" @keydown.enter.prevent="addCustom('languages')" />
            </span>
          </div>
        </div>

        <!-- Step 3: Frameworks -->
        <div x-show="step === 3" x-transition.opacity>
          <h2 class="step-title">Frameworks &amp; Platforms</h2>
          <p class="step-desc">What frameworks and platforms are in your stack?</p>
          <div class="chip-grid">
            <template x-for="fw in frameworks" :key="fw">
              <button class="chip" :class="{ 'chip-selected': data.frameworks.includes(fw) }"
                @click="toggle('frameworks', fw)" x-text="fw"></button>
            </template>
            <template x-for="item in getCustomItems('frameworks')" :key="item">
              <span class="chip chip-selected chip-custom">
                <span x-text="item"></span>
                <button class="chip-remove" @click="removeCustom('frameworks', item)">&times;</button>
              </span>
            </template>
            <span class="chip-add-inline">
              <input type="text" class="chip-add-input" placeholder="+ Add custom"
                x-model="customInput" @keydown.enter.prevent="addCustom('frameworks')" />
            </span>
          </div>
        </div>

        <!-- Step 4: Tools -->
        <div x-show="step === 4" x-transition.opacity>
          <h2 class="step-title">Tools &amp; Infrastructure</h2>
          <p class="step-desc">Select the tools and infrastructure you care about.</p>
          <div class="chip-grid">
            <template x-for="tool in tools" :key="tool">
              <button class="chip" :class="{ 'chip-selected': data.tools.includes(tool) }"
                @click="toggle('tools', tool)" x-text="tool"></button>
            </template>
            <template x-for="item in getCustomItems('tools')" :key="item">
              <span class="chip chip-selected chip-custom">
                <span x-text="item"></span>
                <button class="chip-remove" @click="removeCustom('tools', item)">&times;</button>
              </span>
            </template>
            <span class="chip-add-inline">
              <input type="text" class="chip-add-input" placeholder="+ Add custom"
                x-model="customInput" @keydown.enter.prevent="addCustom('tools')" />
            </span>
          </div>
        </div>

        <!-- Step 5: Topics -->
        <div x-show="step === 5" x-transition.opacity>
          <h2 class="step-title">Topics &amp; Interests</h2>
          <p class="step-desc">What areas of tech do you want to track?</p>
          <div class="chip-grid">
            <template x-for="topic in topics" :key="topic">
              <button class="chip" :class="{ 'chip-selected': data.topics.includes(topic) }"
                @click="toggle('topics', topic)" x-text="topic"></button>
            </template>
            <template x-for="item in getCustomItems('topics')" :key="item">
              <span class="chip chip-selected chip-custom">
                <span x-text="item"></span>
                <button class="chip-remove" @click="removeCustom('topics', item)">&times;</button>
              </span>
            </template>
            <span class="chip-add-inline">
              <input type="text" class="chip-add-input" placeholder="+ Add custom"
                x-model="customInput" @keydown.enter.prevent="addCustom('topics')" />
            </span>
          </div>
        </div>

        <!-- Step 6: Depth -->
        <div x-show="step === 6" x-transition.opacity>
          <h2 class="step-title">Diff Preferences</h2>
          <p class="step-desc">How detailed should your diffs be?</p>
          <div class="depth-options">
            <template x-for="d in depths" :key="d.id">
              <button class="depth-card" :class="{ 'depth-card-selected': data.depth === d.id }"
                @click="data.depth = d.id">
                <span class="depth-icon" x-text="d.icon"></span>
                <span class="depth-label" x-text="d.label"></span>
                <span class="depth-desc" x-text="d.desc"></span>
              </button>
            </template>
          </div>
          <div class="input-group" style="margin-top: 1.5rem;">
            <label class="input-label">Any specific focus areas? (optional)</label>
            <input type="text" class="text-input"
              placeholder="e.g., 'AI coding assistants', 'Rust in production'"
              x-model="data.customFocus" />
          </div>
          <div class="setup-error" x-show="setupError" x-text="setupError"></div>
        </div>
      </div>

      <div class="setup-footer">
        <!-- Back button: only in create mode -->
        <button x-show="step > 0 && !isEditing" class="btn-secondary" @click="step--">
          &larr; Back
        </button>

        <!-- About link: first step, no profiles -->
        <a href="/about" x-show="step === 0 && !hasExistingProfiles && !isEditing" class="btn-secondary">
          About
        </a>

        <!-- Cancel buttons -->
        <button x-show="step === 0 && hasExistingProfiles && !isEditing" class="btn-secondary" @click="cancelWizard()">
          Cancel
        </button>
        <button x-show="isEditing" class="btn-secondary" @click="cancelWizard()">
          Cancel
        </button>

        <div class="setup-footer-spacer"></div>

        <!-- Edit mode: Save + < > navigation -->
        <template x-if="isEditing">
          <div class="edit-footer-actions">
            <button class="btn-primary" @click="saveProfile()" :disabled="saving">
              <span x-show="!saving">Save</span>
              <span x-show="saving">Saving...</span>
            </button>
            <div class="step-nav-btns">
              <button class="btn-step-nav" @click="prevStep()" :disabled="step === 0">&lt;</button>
              <button class="btn-step-nav" @click="step < 6 ? (step === 1 ? nextStep() : step++) : null" :disabled="step === 6">&gt;</button>
            </div>
          </div>
        </template>

        <!-- Create mode: Continue / Start buttons -->
        <template x-if="!isEditing">
          <div class="create-footer-actions">
            <button x-show="step < 6" class="btn-primary"
              @click="(step === 0 && ctrlHeld) ? createDemoProfile() : (step === 1 ? nextStep() : step++)"
              :disabled="(step === 0 && !ctrlHeld && !data.name.trim()) || (step === 1 && !isProviderConfigComplete) || saving">
              <span x-show="!saving && step === 0 && ctrlHeld">&#9670; Create Demo Profile</span>
              <span x-show="!saving && !(step === 0 && ctrlHeld)">Continue &rarr;</span>
              <span x-show="saving">Creating...</span>
            </button>
            <button x-show="step === 6" class="btn-primary" @click="saveProfile()" :disabled="saving">
              <span x-show="!saving">Start Diffing &#9670;</span>
              <span x-show="saving">Saving...</span>
            </button>
          </div>
        </template>
    </div>
  </main>
</body>
</html>
