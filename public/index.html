<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>diffÂ·log</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/styles.css" />
  <script type="module" src="/app.js"></script>
</head>

<body>
  <main id="content" x-data="dashboard()" x-init="init()">
    <header>
      <div class="header-left">
        <div class="logo-mark-header" :class="{ 'logo-mark-spinning': generating }">
          &#9670;
        </div>
        <div @click="showLastDiff()" :style="$store.app.history.length > 0 ? 'cursor:pointer' : ''">
          <h1 class="main-title">
            diff<span class="title-diamond">&#9670;</span>log
          </h1>
          <p class="header-date" x-text="currentDate"></p>
        </div>
      </div>
      <div class="header-right">
        <div class="header-profile-group">
          <a href="/stars" class="header-link" x-show="$store.app.stars?.length > 0">
            <span class="header-link-icon">&#9733;</span>
            <span x-text="$store.app.starCountLabel"></span>
          </a>
          <a href="/profiles" class="profile-badge">
            <svg class="profile-badge-icon" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="11" r="4" />
              <path d="M4 22c0-4.4 3.6-8 8-8s8 3.6 8 8" />
            </svg>
            <span x-text="$store.app.profile?.name || 'Profile'"></span>
          </a>
        </div>
        <!-- @include partials/sync-dropdown.html -->
      </div>
    </header>

    <!-- Sync Notification Banner -->
    <div class="sync-banner" x-show="needsSyncPrompt()" x-transition.opacity>
      <span class="sync-banner-icon">&#8635;</span>
      <span class="sync-banner-text">You have unsynced changes</span>
      <button class="sync-banner-btn" @click="$store.app.openSyncDropdown()">
        Sync Now
      </button>
      <button class="sync-banner-dismiss" @click="dismissSyncBanner()" title="Dismiss">
        &times;
      </button>
    </div>

    <!-- Profile Summary Bar -->
    <div class="profile-summary" x-show="showProfile" x-transition.opacity>
      <div class="profile-section">
        <span class="profile-label-row">
          <span class="profile-label">TRACKING</span>
          <a href="/setup?edit=1" class="edit-icon-btn" title="Edit tracking">&#9998;</a>
        </span>
        <span class="profile-value profile-value-wrap" x-text="trackingText()"></span>
      </div>
      <div class="profile-section">
        <span class="profile-label-row">
          <span class="profile-label">FOCUS</span>
          <a href="/setup?edit=4" class="edit-icon-btn" title="Edit topics">&#9998;</a>
        </span>
        <span class="profile-value" x-text="($store.app.profile?.topics || []).slice(0, 3).join(' \u00b7 ')"></span>
      </div>
      <div class="profile-section">
        <span class="profile-label-row">
          <span class="profile-label">MODE</span>
          <a href="/setup?edit=5" class="edit-icon-btn" title="Edit preferences">&#9998;</a>
        </span>
        <span class="profile-value" x-text="depthLabel()"></span>
      </div>
      <div class="profile-section">
        <a href="/archive" class="btn-archive">
          <span class="archive-icon">&#9632;</span> Archive (<span x-text="$store.app.history.length"></span>)
        </a>
      </div>
    </div>

    <!-- Welcome + Diff (shown together when recent diff exists) -->
    <div x-show="diff && !generating && !error">
      <div class="welcome-bar">
        <div>
          <span class="welcome-greeting" x-text="welcomeHeading()"></span>
          <span class="welcome-ago">
            <span x-text="diff ? (nextDiff() ? 'Here\'s your diff' : 'Here\'s your latest diff') : ''"></span>
            <code class="diff-time" x-show="diff" x-text="diff ? timeAgo(diff.generated_at) : ''"></code>

            <!-- Streak Badge -->
            <div class="streak-wrapper" tabindex="0" x-show="$store.app.streak.streak >= 2" x-transition.opacity>

              <div class="streak-badge-btn">
                <span class="streak-icon" :class="{
                    'streak-icon-tiny': $store.app.streak.streak < 5,
                    'streak-icon-sm': $store.app.streak.streak >= 5 && $store.app.streak.streak < 10,
                    'streak-icon-med': $store.app.streak.streak >= 10 && $store.app.streak.streak < 20,
                    'streak-icon-full': $store.app.streak.streak >= 20
                  }">&#128293;</span>
                <span x-text="$store.app.streak.streak"></span>
              </div>

              <!-- Streak Dropdown -->
              <div class="streak-dropdown">

                <div class="streak-info-row">
                  <span class="streak-label">Current streak</span>
                  <span class="streak-value"><span class="streak-icon streak-icon-sm">&#128293;</span> <span
                      x-text="$store.app.streak.streak + ' diffs'"></span></span>
                </div>

                <div class="streak-warning" x-show="$store.app.streak.expiresInDays <= 3">
                  <span x-show="$store.app.streak.expiresInDays > 1">expires in <span
                      x-text="$store.app.streak.expiresInDays"></span> days!</span>
                  <span x-show="$store.app.streak.expiresInDays <= 1">expires tomorrow!</span>
                </div>

                <div class="streak-calendar-wrapper">
                  <template x-for="month in $store.app.streakCalendar">
                    <div class="streak-month">
                      <div class="streak-month-label" x-text="month.monthLabel"></div>
                      <div class="streak-calendar-header">
                        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                      </div>
                      <div class="streak-calendar">
                        <template x-for="week in month.weeks">
                          <div class="calendar-week">
                            <template x-for="day in week">
                              <div class="calendar-day"
                                :class="{ 'day-active': day.isActive, 'day-gap': day.isGap, 'day-today': day.isToday, 'day-outside': day.isOutside }"
                                :title="day.isActive ? new Date(day.iso).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : ''">
                                <span x-show="day.isActive">&#9670;</span>
                                <span x-show="!day.isActive && day.isGap" class="day-gap-dot">&middot;</span>
                              </div>
                            </template>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            <button class="btn-generate-inline btn-branded" x-show="!isTodayDiff()" @click="diff = null">
              New Diff
            </button>
          </span>
        </div>
        <div class="welcome-bar-right">
          <a x-show="$store.app.history.length === 1" href="/archive" class="diff-position-link"
            x-text="diffPosition()"></a>
          <span class="diff-nav-inline" x-show="$store.app.history.length > 1">
            <button class="diff-nav-arrow" :class="{ 'diff-nav-arrow-disabled': !prevDiff() }"
              @click="if (prevDiff()) diff = prevDiff()" title="Older">
              &lsaquo;
            </button>
            <a href="/archive" class="diff-position-link" x-text="diffPosition()"></a>
            <button class="diff-nav-arrow" :class="{ 'diff-nav-arrow-disabled': !nextDiff() }"
              @click="if (nextDiff()) diff = nextDiff()" title="Newer">
              &rsaquo;
            </button>
          </span>
        </div>
      </div>
      <div class="diff-container">
        <div class="diff-title-row" x-show="diff?.title">
          <h1 class="diff-title">
            <span class="diff-title-icon">&#9632;</span>
            <span x-text="diff?.title"></span>
          </h1>
          <div x-data="{ get diffRef() { return diff; } }">
            <!-- @include partials/share-dropdown.html -->
          </div>
        </div>
        <div class="diff-content" x-html="diff ? $store.app.renderDiff(diff) : ''"
          x-effect="if (diff) injectBookmarkButtons()" @click="handleBookmarkClick($event)"></div>
      </div>
      <div class="diff-footer">
        <button class="btn-secondary btn-sm" x-show="prevDiff()" @click="diff = prevDiff()">
          &larr; Older
        </button>
        <span x-show="!prevDiff()"></span>
        <button class="btn-secondary btn-sm" x-show="nextDiff()" @click="diff = nextDiff()">
          Newer &rarr;
        </button>
        <button class="btn-secondary btn-sm btn-branded" x-show="isTodayDiff() && !nextDiff()" @click="diff = null">
          Regenerate
        </button>
      </div>
    </div>

    <!-- No diff yet -->
    <div x-show="!diff && !generating && !error" class="welcome-area">
      <h1 class="welcome-heading-lg" x-text="welcomeHeading()"></h1>
      <p class="welcome-text" x-html="welcomeText()"></p>
      <!-- First-time profile summary -->
      <div class="first-time-tracking" x-show="$store.app.history.length === 0">
        <div class="first-time-tracking-label">Tracking</div>
        <div class="first-time-tracking-items" x-text="trackingText()"></div>
        <a href="/setup?edit=1" class="first-time-tracking-edit">edit</a>
      </div>
      <button class="btn-generate btn-branded" @click="generate()" :disabled="generating">
        <span x-text="isTodayDiff() && !ctrlHeld ? 'Regenerate Diff' : 'Generate Diff'"></span>
      </button>
      <div class="depth-selector">
        <template
          x-for="d in [{id:'quick',label:'Quick Scan',icon:'\u26A1'},{id:'standard',label:'Standard Brief',icon:'\uD83D\uDCCB'},{id:'deep',label:'Deep Dive',icon:'\uD83D\uDD2C'}]"
          :key="d.id">
          <button class="depth-option"
            :class="{ 'depth-option-active': selectedDepth === d.id, 'depth-option-default': d.id === $store.app.profile?.depth }"
            @click="selectedDepth = d.id">
            <span class="depth-option-icon" x-text="d.icon"></span>
            <span x-text="d.label"></span>
          </button>
        </template>
      </div>
      <button class="btn-show-prompt" @click="previewPrompt()">
        Show Prompt
      </button>
      <div x-show="$store.app.history.length > 0" class="recent-archive">
        <template x-for="b in $store.app.history.slice(0, 3)" :key="b.id">
          <div class="recent-archive-item" @click="diff = b">
            <span class="recent-archive-date" x-text="timeAgo(b.generated_at)"></span>
            <span class="recent-archive-preview"
              x-text="b.title || (b.content.slice(0, 80).replace(/[#*\[\]]/g, '') + '...')"></span>
          </div>
        </template>
        <a x-show="$store.app.history.length > 3" href="/archive" class="recent-archive-more">more...</a>
      </div>
    </div>

    <!-- Generating State -->
    <div x-show="generating" class="generating-state">
      <div class="scan-animation">
        <div class="scan-line"></div>
      </div>
      <div class="scan-message-container">
        <span class="scan-icon" x-text="scanMessages[scanIndex].icon"></span>
        <p class="generating-text" x-text="scanMessages[scanIndex].text"></p>
      </div>
      <div class="scan-progress">
        <template x-for="i in 8" :key="i">
          <div class="progress-dot" :class="{ 'progress-dot-active': (i - 1) <= (scanIndex % 8) }"></div>
        </template>
      </div>
      <p class="generating-subtext" x-text="estimatedTime()"></p>
    </div>

    <!-- Error -->
    <div x-show="error && !generating" class="error-box">
      <div class="error-icon">&#9888;&#65039;</div>
      <p class="error-text" x-text="error"></p>
      <button class="btn-retry" @click="generate()">Try Again</button>
    </div>

    <!-- Prompt Preview Modal -->
    <dialog class="lg" x-dialog="showPrompt">
      <header>
        <h2 class="dialog-title subtle">Prompt Preview</h2>
        <button class="dialog-close" x-dialog-close>&times;</button>
      </header>
      <pre class="prompt-text" x-text="promptText"></pre>
    </dialog>

  </main>
  <!-- @include partials/site-footer.html -->
</body>

</html>