<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>diff·log - Profiles</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/styles.css" />
    <script type="module" src="/app.js"></script>
  </head>
  <body>
    <main id="content" x-data="profiles()">
      <header>
          <div class="header-left">
            <div class="logo-mark-header logo-mark-user">
              <svg
                viewBox="0 0 24 24"
                width="16"
                height="16"
                fill="currentColor"
              >
                <circle cx="12" cy="11" r="4" />
                <path d="M4 22c0-4.4 3.6-8 8-8s8 3.6 8 8" />
              </svg>
            </div>
            <div>
              <h1 class="main-title">
                <a href="/" class="main-title-link"
                  >diff<span class="title-diamond">&#9670;</span>log</a
                >
                profiles
              </h1>
              <p class="header-date">Manage your profiles</p>
            </div>
          </div>
        </header>

        <!-- Saved Profiles -->
        <div class="profiles-section" x-show="Object.keys(profiles).length > 0" x-cloak>
          <h2 class="profiles-section-title">Your Profiles</h2>
          <p class="profiles-section-desc" x-show="Object.keys(profiles).length > 1">Click to switch</p>

          <div class="profiles-list">
            <template
              x-for="[id, profile] in Object.entries(profiles)"
              :key="id"
            >
              <div
                class="profile-card-full"
                :class="{ 'profile-card-full-active': id === activeProfileId }"
              >
                <div
                  class="profile-card-full-header"
                  @click="switchProfile(id)"
                >
                  <div class="profile-card-icon">
                    <svg
                      viewBox="0 0 24 24"
                      width="20"
                      height="20"
                      fill="currentColor"
                    >
                      <circle cx="12" cy="11" r="4" />
                      <path d="M4 22c0-4.4 3.6-8 8-8s8 3.6 8 8" />
                    </svg>
                  </div>
                  <div class="profile-card-full-title">
                    <div class="profile-card-name">
                      <span x-text="profile.name"></span>
                      <span
                        class="profile-status profile-status-shared"
                        x-show="profile.syncedAt"
                        x-text="'synced ' + new Date(profile.syncedAt).toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit' })"
                      ></span>
                      <button
                        class="profile-status-share"
                        x-show="profile.syncedAt"
                        @click.stop="showShareInfo(id)"
                      >
                        &#8599; share
                      </button>
                      <span
                        class="profile-status profile-status-warning"
                        x-show="profile.syncedAt === null"
                        x-cloak
                        title="Profile not found on server"
                        >not on server</span
                      >
                      <span
                        class="profile-status profile-status-local"
                        x-show="!('syncedAt' in profile)"
                        x-cloak
                        >local</span
                      >
                      <button
                        class="profile-status-share"
                        x-show="!profile.syncedAt"
                        @click.stop="startShare(id)"
                      >
                        &#8599; upload
                      </button>
                    </div>
                    <div class="profile-card-id">
                      <span x-text="id.slice(0, 8)"></span>
                      <!-- Active profile: full dropdown -->
                      <template x-if="id === $store.app.activeProfileId">
                        <!-- @include partials/sync-dropdown.html -->
                      </template>
                      <!-- Non-active synced profiles: status only -->
                      <template x-if="profile.syncedAt && id !== $store.app.activeProfileId">
                        <span class="sync-status-static" :title="$store.app.hasRememberedPasswordFor(id) ? 'Synced' : 'Password required'">
                          <span class="sync-status-cloud">&#9729;</span>
                          <span class="sync-status-indicator sync-status-pending" x-show="!$store.app.hasRememberedPasswordFor(id)">&#9670;</span>
                        </span>
                      </template>
                    </div>
                  </div>
                  <div class="profile-card-full-actions">
                    <a
                      class="profile-card-edit"
                      @click.stop="$store.app.switchProfile(id); window.location.href='/setup?edit=0'"
                      title="Edit profile"
                      >&#9998;</a
                    >
                    <button
                      class="profile-card-password"
                      x-show="profile.syncedAt"
                      @click.stop="startPasswordUpdate(id)"
                      title="Change password"
                    >
                      ***
                    </button>
                    <button
                      class="profile-card-remove"
                      @click.stop="deleteProfile(id)"
                      title="Delete profile"
                    >
                      &times;
                    </button>
                  </div>
                </div>
                <div
                  class="profile-card-full-details"
                  @click="switchProfile(id)"
                >
                  <div
                    class="profile-detail-row"
                    x-show="profile.languages?.length"
                  >
                    <span class="profile-detail-label">Languages</span>
                    <span
                      class="profile-detail-value"
                      x-text="profile.languages?.join(', ')"
                    ></span>
                  </div>
                  <div
                    class="profile-detail-row"
                    x-show="profile.frameworks?.length"
                  >
                    <span class="profile-detail-label">Frameworks</span>
                    <span
                      class="profile-detail-value"
                      x-text="profile.frameworks?.join(', ')"
                    ></span>
                  </div>
                  <div
                    class="profile-detail-row"
                    x-show="profile.tools?.length"
                  >
                    <span class="profile-detail-label">Tools</span>
                    <span
                      class="profile-detail-value"
                      x-text="profile.tools?.join(', ')"
                    ></span>
                  </div>
                  <div
                    class="profile-detail-row"
                    x-show="profile.topics?.length"
                  >
                    <span class="profile-detail-label">Topics</span>
                    <span
                      class="profile-detail-value"
                      x-text="profile.topics?.join(', ')"
                    ></span>
                  </div>
                  <div class="profile-detail-row profile-detail-counts">
                    <a href="/archive" class="profile-count profile-count-link" @click.stop="if ($store.app.activeProfileId !== id) { $store.app.switchProfile(id) }"
                      ><span class="profile-count-icon">&#9632;</span>
                      <span class="link-secondary"
                        x-text="(($store.app.histories[id] || []).length) + ' ' + (($store.app.histories[id] || []).length === 1 ? 'diff' : 'diffs')"
                      ></span
                    ></a>
                    <span
                      class="profile-count profile-count-stars"
                      x-show="($store.app.bookmarks[id] || []).length > 0"
                      ><span class="profile-count-icon">★</span>
                      <span
                        x-text="(($store.app.bookmarks[id] || []).length) + ' ' + (($store.app.bookmarks[id] || []).length === 1 ? 'star' : 'stars')"
                      ></span
                    ></span>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Reminders -->
        <div class="reminders-section" x-data="reminders()" x-show="Object.keys($store.app.profiles).length > 0 || settings.enabled" x-cloak>
          <div class="reminders-title-row">
            <div>
              <h2 class="profiles-section-title">Reminders</h2>
              <p class="profiles-section-desc">Get notified to check your diff</p>
            </div>
            <div class="reminders-title-actions" x-show="permission === 'granted'">
              <span
                class="reminders-status-text"
                :class="{ 'reminders-status-text-dim': !settings.enabled || settings.days.length === 0 }"
                x-text="!settings.enabled ? 'Paused' : settings.days.length === 0 ? 'No days' : 'Enabled'"
              ></span>
              <button
                class="btn-secondary btn-sm"
                @click="toggleEnabled()"
                x-text="settings.enabled ? 'Pause' : 'Resume'"
              ></button>
            </div>
          </div>

          <div class="reminders-card">
            <!-- Permission not yet requested -->
            <template x-if="permission === 'default'">
              <div class="reminders-enable">
                <button class="btn-primary" @click="requestPermission()">
                  Enable Notifications
                </button>
                <p class="reminders-note">Reminders are stored on this device only</p>
              </div>
            </template>

            <!-- Permission denied -->
            <template x-if="permission === 'denied'">
              <div class="reminders-denied">
                <p class="reminders-denied-text">
                  Notifications are blocked. Enable them in your browser settings to use reminders.
                </p>
              </div>
            </template>

            <!-- Permission granted -->
            <template x-if="permission === 'granted'">
              <div class="reminders-config">
                <div class="reminders-schedule" x-show="settings.enabled">
                  <div class="reminders-days">
                    <template x-for="(label, day) in dayLabels" :key="day">
                      <button
                        class="reminder-day"
                        :class="{ 'reminder-day-active': isDayActive(day) }"
                        :title="dayNames[day]"
                        @click="toggleDay(day)"
                        x-text="label"
                      ></button>
                    </template>
                  </div>

                  <div class="reminders-time">
                    <label class="reminders-time-label">Time</label>
                    <input
                      type="time"
                      class="reminders-time-input"
                      :value="settings.time"
                      @change="updateTime($event)"
                    />
                  </div>
                </div>

                <p class="reminders-paused-msg" x-show="!settings.enabled">
                  Reminders are paused. Click Resume to re-enable.
                </p>
              </div>
            </template>
          </div>
        </div>

        <!-- Action Cards -->
        <div class="profiles-actions">
          <!-- Create New -->
          <a href="/setup" class="profile-card profile-card-action">
            <div class="profile-card-action-icon">+</div>
            <div class="profile-card-name">Create New</div>
            <div class="profile-card-id">Configure your personalized diff</div>
          </a>

          <!-- Import Existing -->
          <button
            class="profile-card profile-card-action profile-card-action-alt"
            @click="showImport = true"
          >
            <div class="profile-card-action-icon">&#8595;</div>
            <div class="profile-card-name">Import Existing</div>
            <div class="profile-card-id">Add from another device</div>
          </button>
        </div>

        <!-- Import Modal -->
        <dialog class="sm dark" x-dialog="showImport" @close="importError = ''">
            <div class="dialog-body padded">
              <h2 class="unlock-title">Import Shared Profile</h2>
              <p class="unlock-subtitle">Sync a profile that's been uploaded to the server from another device.</p>

              <div class="input-group">
                <label class="input-label">Profile ID</label>
                <div class="input-with-action">
                  <input
                    type="text"
                    class="text-input"
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                    x-model="importProfileId"
                    autofocus
                  />
                  <button
                    class="btn-inline-action"
                    @click="showImport = false; startScanner()"
                  >Scan QR</button>
                </div>
              </div>

              <div class="input-group">
                <label class="input-label">Password</label>
                <input
                  type="password"
                  class="text-input"
                  placeholder="Enter the share password"
                  x-model="importPassword"
                  @keydown.enter="importProfile()"
                />
              </div>

              <label class="remember-password">
                <input type="checkbox" x-model="importRemember" />
                <span>Remember password</span>
              </label>

              <div
                class="unlock-error"
                x-show="importError"
                x-text="importError"
              ></div>
            </div>

            <footer>
              <button class="btn-secondary" x-dialog-close>
                Cancel
              </button>
              <button
                class="btn-primary"
                @click="importProfile()"
                :disabled="!importProfileId.trim() || !importPassword || importing"
              >
                <span x-show="!importing">Import</span>
                <span x-show="importing">Importing...</span>
              </button>
            </footer>
        </dialog>

        <!-- QR Scanner Modal -->
        <dialog class="sm dark scanner-modal" x-dialog="showScanner" @close="stopScanner()">
            <div class="dialog-body padded">
              <h2 class="unlock-title">Scan QR Code</h2>
              <p class="unlock-subtitle">
                Point your camera at a profile QR code
              </p>

              <div class="scanner-container">
                <video
                  x-ref="scannerVideo"
                  class="scanner-video"
                  playsinline
                ></video>
                <div class="scanner-overlay">
                  <div class="scanner-frame"></div>
                </div>
              </div>

              <div
                class="scanner-error"
                x-show="scannerError"
                x-text="scannerError"
              ></div>
            </div>

            <footer>
              <button class="btn-secondary" x-dialog-close @click="showImport = true">
                Back
              </button>
            </footer>
        </dialog>

        <!-- Share Modal -->
        <dialog class="sm dark" x-dialog="showShare" @close="shareError = ''; sharePassword = ''; sharePasswordConfirm = ''">
            <div class="dialog-body padded">
              <h2 class="unlock-title">Upload Profile</h2>
              <p class="unlock-subtitle">
                Your profile data and API key will be encrypted with your
                password, then uploaded securely.
              </p>

              <div class="share-info">
                <div class="share-info-item">
                  <span class="share-info-icon">&#128274;</span>
                  <span>Password encrypts your API key locally</span>
                </div>
                <div class="share-info-item">
                  <span class="share-info-icon">&#9729;</span>
                  <span>Encrypted data stored on server</span>
                </div>
                <div class="share-info-item">
                  <span class="share-info-icon">&#128273;</span>
                  <span>Only someone with the password can decrypt</span>
                </div>
              </div>

              <div class="input-group">
                <label class="input-label">Choose a password</label>
                <input
                  type="password"
                  class="text-input"
                  placeholder="Enter a secure password"
                  x-model="sharePassword"
                  @keydown.enter="shareProfile()"
                  autofocus
                />
              </div>

              <div class="input-group">
                <label class="input-label">Confirm password</label>
                <input
                  type="password"
                  class="text-input"
                  placeholder="Re-enter password"
                  x-model="sharePasswordConfirm"
                  @keydown.enter="shareProfile()"
                />
              </div>

              <label class="remember-password">
                <input type="checkbox" x-model="shareRemember" />
                <span>Remember password</span>
              </label>

              <div
                class="unlock-error"
                x-show="shareError"
                x-text="shareError"
              ></div>
            </div>

            <footer>
              <button class="btn-secondary" x-dialog-close>
                Cancel
              </button>
              <button
                class="btn-primary"
                @click="shareProfile()"
                :disabled="!sharePassword || sharePassword !== sharePasswordConfirm || sharing"
              >
                <span x-show="!sharing">Upload</span>
                <span x-show="sharing">Uploading...</span>
              </button>
            </footer>
        </dialog>

        <!-- Share Info Modal -->
        <dialog class="sm dark" x-dialog="showInfo">
            <div class="dialog-body padded">
              <h2 class="unlock-title">Share Profile</h2>
              <p class="unlock-subtitle">
                Share this profile with another device or person
              </p>

              <div class="share-qr-container" x-show="qrDataUrl">
                <img :src="qrDataUrl" alt="QR Code" class="share-qr" />
              </div>

              <div class="share-id-box">
                <label class="input-label">Profile ID</label>
                <div class="share-id-row">
                  <code class="share-id-code" x-text="infoProfileId"></code>
                  <button
                    class="btn-copy"
                    @click="copyId()"
                    x-text="copied ? 'Copied!' : 'Copy'"
                  ></button>
                </div>
              </div>

              <p class="share-note">
                The recipient will need this ID and your password to import the
                profile.
              </p>
            </div>

            <footer>
              <button class="btn-secondary" x-dialog-close>
                Close
              </button>
            </footer>
        </dialog>

        <!-- Password Update Modal -->
        <dialog class="sm dark" x-dialog="showPasswordUpdate" @close="passwordUpdateError = ''; passwordUpdateSuccess = false; currentPassword = ''; newPassword = ''; newPasswordConfirm = ''">
            <div class="dialog-body padded">
              <h2 class="unlock-title">Change Password</h2>
              <p class="unlock-subtitle" x-show="!passwordUpdateSuccess">
                Update your sync password. All data will be re-encrypted with the
                new password.
              </p>

              <template x-if="!passwordUpdateSuccess">
                <div>
                  <div class="share-info">
                    <div class="share-info-item">
                      <span class="share-info-icon">&#128274;</span>
                      <span>Your API key and data will be re-encrypted</span>
                    </div>
                    <div class="share-info-item">
                      <span class="share-info-icon">&#9729;</span>
                      <span>Server data updated atomically</span>
                    </div>
                    <div class="share-info-item">
                      <span class="share-info-icon">&#128273;</span>
                      <span>Old password will no longer work</span>
                    </div>
                  </div>

                  <div class="input-group">
                    <label class="input-label">Current password</label>
                    <input
                      type="password"
                      class="text-input"
                      placeholder="Enter your current password"
                      x-model="currentPassword"
                      autofocus
                    />
                  </div>

                  <div class="input-group">
                    <label class="input-label">New password</label>
                    <input
                      type="password"
                      class="text-input"
                      placeholder="At least 8 characters"
                      x-model="newPassword"
                    />
                  </div>

                  <div class="input-group">
                    <label class="input-label">Confirm new password</label>
                    <input
                      type="password"
                      class="text-input"
                      placeholder="Re-enter new password"
                      x-model="newPasswordConfirm"
                      @keydown.enter="doPasswordUpdate()"
                    />
                  </div>

                  <div
                    class="unlock-error"
                    x-show="passwordUpdateError"
                    x-text="passwordUpdateError"
                  ></div>
                </div>
              </template>

              <template x-if="passwordUpdateSuccess">
                <div class="sync-result">
                  <div class="sync-result-icon">&#10003;</div>
                  <p class="sync-result-text">Password updated successfully!</p>
                </div>
              </template>
            </div>

            <footer x-show="!passwordUpdateSuccess">
              <button class="btn-secondary" x-dialog-close>
                Cancel
              </button>
              <button
                class="btn-primary"
                @click="doPasswordUpdate()"
                :disabled="!currentPassword || !newPassword || newPassword !== newPasswordConfirm || passwordUpdating"
              >
                <span x-show="!passwordUpdating">Update Password</span>
                <span x-show="passwordUpdating">Updating...</span>
              </button>
            </footer>

            <footer x-show="passwordUpdateSuccess">
              <button class="btn-primary" x-dialog-close>
                Done
              </button>
            </footer>
        </dialog>

    </main>
    <!-- @include partials/site-footer.html -->
  </body>
</html>
